{% extends "base.html" %}

{% block title %}{{ room['name'] }} - å¤§å–œåˆ©ã‚¢ãƒ—ãƒª{% endblock %}

{% block extra_css %}
<style>
    .player-card {
        background: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .ready-badge {
        background: #28a745;
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9em;
    }
    
    .not-ready-badge {
        background: #6c757d;
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9em;
    }
    
    .answer-box {
        background: #f8f9fa;
        border: 2px solid #ddd;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .answer-box:hover {
        border-color: #667eea;
        transform: scale(1.02);
    }
    
    .answer-box.selected {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }
    
    .timer {
        font-size: 3em;
        font-weight: bold;
        color: #667eea;
        text-align: center;
        margin: 20px 0;
    }
    
    .timer.warning {
        color: #dc3545;
        animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
</style>
{% endblock %}

{% block content %}
<h1>ğŸšª {{ room['name'] }}</h1>

<div id="waiting-area" class="card">
    <h2>å¾…æ©Ÿä¸­...</h2>
    <p style="color: #666; margin-bottom: 20px;">3äººä»¥ä¸Šã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæº–å‚™å®Œäº†ã™ã‚‹ã¨è‡ªå‹•çš„ã«ã‚²ãƒ¼ãƒ ãŒé–‹å§‹ã•ã‚Œã¾ã™</p>
    
    <div id="players-list"></div>
    
    <div style="text-align: center; margin-top: 20px;">
        <button id="ready-btn" class="btn">æº–å‚™å®Œäº†</button>
        <a href="{{ url_for('rooms') }}" class="btn btn-secondary" style="margin-left: 10px;">é€€å®¤</a>
    </div>
</div>

<div id="answering-area" class="card" style="display: none;">
    <h2>å›ç­”ãƒ•ã‚§ãƒ¼ã‚º</h2>
    
    <div id="topic-display" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px; text-align: center; margin-bottom: 20px;">
        <p style="font-size: 1.8em; font-weight: bold;" id="topic-text"></p>
        <p style="margin-top: 10px; font-size: 0.9em;" id="topic-creator"></p>
    </div>
    
    <div class="timer" id="timer">2:00</div>
    
    <textarea id="answer-input" rows="5" placeholder="ã‚ãªãŸã®å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." style="margin-bottom: 15px;"></textarea>
    
    <div style="text-align: center;">
        <button id="submit-answer-btn" class="btn">å›ç­”ã‚’æå‡º</button>
    </div>
</div>

<div id="voting-area" class="card" style="display: none;">
    <h2>æŠ•ç¥¨ãƒ•ã‚§ãƒ¼ã‚º</h2>
    <p style="color: #666; margin-bottom: 20px;">1ä½ã¨2ä½ã®å›ç­”ã‚’é¸ã‚“ã§ãã ã•ã„ï¼ˆè‡ªåˆ†ã®å›ç­”ã«ã¯æŠ•ç¥¨ã§ãã¾ã›ã‚“ï¼‰</p>
    
    <div id="answers-list"></div>
    
    <div style="text-align: center; margin-top: 20px;">
        <p style="margin-bottom: 10px;">
            <strong>1ä½:</strong> <span id="first-place-display">æœªé¸æŠ</span> | 
            <strong>2ä½:</strong> <span id="second-place-display">æœªé¸æŠ</span>
        </p>
        <button id="submit-vote-btn" class="btn" disabled>æŠ•ç¥¨ã‚’ç¢ºå®š</button>
    </div>
</div>

<div id="results-area" class="card" style="display: none;">
    <h2>çµæœç™ºè¡¨ï¼</h2>
    
    <div id="results-list"></div>
    
    <div style="text-align: center; margin-top: 30px;">
        <button id="continue-btn" class="btn">ç¶™ç¶šï¼ˆãƒã‚¤ãƒ³ãƒˆå¼•ãç¶™ãï¼‰</button>
        <button id="new-game-btn" class="btn btn-secondary" style="margin-left: 10px;">æ–°ã‚²ãƒ¼ãƒ ï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰</button>
        <button id="end-btn" class="btn btn-danger" style="margin-left: 10px;">çµ‚äº†</button>
    </div>
    
    <div style="margin-top: 20px; text-align: center;">
        <button id="save-answer-btn" class="btn" style="background: #28a745;">æ°—ã«å…¥ã£ãŸå›ç­”ã‚’ä¿å­˜</button>
    </div>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
    const socket = io();
    const roomId = {{ room['id'] }};
    let currentState = 'waiting';
    let timerInterval = null;
    let myAnswer = '';
    let allAnswers = [];
    let selectedFirst = null;
    let selectedSecond = null;
    let gameResults = null;
    
    // ãƒ«ãƒ¼ãƒ ã«å‚åŠ 
    socket.emit('join_room', {room_id: roomId});
    
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆæ›´æ–°
    socket.on('room_update', (data) => {
        updatePlayersList(data.players);
        currentState = data.state;
    });
    
    // ã‚²ãƒ¼ãƒ é–‹å§‹
    socket.on('game_start', (data) => {
        currentState = 'answering';
        showAnsweringArea(data);
        startTimer(data.timer);
    });
    
    // æŠ•ç¥¨ãƒ•ã‚§ãƒ¼ã‚º
    socket.on('voting_phase', (data) => {
        currentState = 'voting';
        showVotingArea(data.answers);
    });
    
    // çµæœè¡¨ç¤º
    socket.on('game_results', (data) => {
        currentState = 'results';
        gameResults = data;
        showResults(data);
    });
    
    // ãƒ›ãƒ¼ãƒ ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    socket.on('redirect_home', () => {
        window.location.href = '{{ url_for("home") }}';
    });
    
    // æº–å‚™å®Œäº†ãƒœã‚¿ãƒ³
    document.getElementById('ready-btn').addEventListener('click', () => {
        socket.emit('ready', {room_id: roomId});
        document.getElementById('ready-btn').disabled = true;
        document.getElementById('ready-btn').textContent = 'æº–å‚™å®Œäº†æ¸ˆã¿';
    });
    
    // å›ç­”æå‡º
    document.getElementById('submit-answer-btn').addEventListener('click', () => {
        const answer = document.getElementById('answer-input').value.trim();
        if (!answer) {
            alert('å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        myAnswer = answer;
        socket.emit('submit_answer', {room_id: roomId, answer: answer});
        document.getElementById('submit-answer-btn').disabled = true;
        document.getElementById('answer-input').disabled = true;
        alert('å›ç­”ã‚’æå‡ºã—ã¾ã—ãŸï¼ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å›ç­”ã‚’å¾…ã£ã¦ã„ã¾ã™...');
    });
    
    // æŠ•ç¥¨ç¢ºå®š
    document.getElementById('submit-vote-btn').addEventListener('click', () => {
        if (selectedFirst === null || selectedSecond === null) {
            alert('1ä½ã¨2ä½ã‚’é¸æŠã—ã¦ãã ã•ã„');
            return;
        }
        socket.emit('submit_vote', {
            room_id: roomId,
            first_place: selectedFirst,
            second_place: selectedSecond
        });
        document.getElementById('submit-vote-btn').disabled = true;
        alert('æŠ•ç¥¨ã—ã¾ã—ãŸï¼ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æŠ•ç¥¨ã‚’å¾…ã£ã¦ã„ã¾ã™...');
    });
    
    // ã‚²ãƒ¼ãƒ ç¶™ç¶šãƒ»çµ‚äº†ãƒœã‚¿ãƒ³
    document.getElementById('continue-btn').addEventListener('click', () => {
        socket.emit('game_action', {room_id: roomId, action: 'continue'});
    });
    
    document.getElementById('new-game-btn').addEventListener('click', () => {
        socket.emit('game_action', {room_id: roomId, action: 'new_game'});
    });
    
    document.getElementById('end-btn').addEventListener('click', () => {
        if (confirm('æœ¬å½“ã«çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ')) {
            socket.emit('game_action', {room_id: roomId, action: 'end'});
        }
    });
    
    // å›ç­”ä¿å­˜
    document.getElementById('save-answer-btn').addEventListener('click', () => {
        if (!gameResults) return;
        
        const topic = document.getElementById('topic-text').textContent;
        let selectedAnswer = prompt('ä¿å­˜ã—ãŸã„å›ç­”ã®ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ1ã€œ' + gameResults.players.length + 'ï¼‰');
        
        if (selectedAnswer) {
            const idx = parseInt(selectedAnswer) - 1;
            if (idx >= 0 && idx < gameResults.players.length) {
                fetch('{{ url_for("add_to_storage") }}', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        topic: topic,
                        answer: gameResults.players[idx].answer,
                        answer_owner: gameResults.players[idx].username
                    })
                }).then(r => r.json()).then(data => {
                    if (data.success) {
                        alert('å›ç­”ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
                    }
                });
            }
        }
    });
    
    function updatePlayersList(players) {
        const list = document.getElementById('players-list');
        list.innerHTML = '<h3 style="margin-bottom: 15px;">å‚åŠ è€… (' + players.length + 'äºº)</h3>';
        
        players.forEach(player => {
            const card = document.createElement('div');
            card.className = 'player-card';
            card.innerHTML = `
                <span style="font-weight: bold;">${player.username}</span>
                <span class="${player.ready ? 'ready-badge' : 'not-ready-badge'}">
                    ${player.ready ? 'æº–å‚™å®Œäº†' : 'å¾…æ©Ÿä¸­'}
                </span>
            `;
            list.appendChild(card);
        });
    }
    
    function showAnsweringArea(data) {
        document.getElementById('waiting-area').style.display = 'none';
        document.getElementById('answering-area').style.display = 'block';
        document.getElementById('voting-area').style.display = 'none';
        document.getElementById('results-area').style.display = 'none';
        
        document.getElementById('topic-text').textContent = data.topic.content;
        if (data.topic.is_anonymous) {
            document.getElementById('topic-creator').textContent = 'åŒ¿å';
        } else {
            document.getElementById('topic-creator').textContent = 'ä½œæˆè€…: ' + (data.topic.username || 'ä¸æ˜');
        }
    }
    
    function startTimer(endTime) {
        if (timerInterval) clearInterval(timerInterval);
        
        timerInterval = setInterval(() => {
            const now = Date.now() / 1000;
            const remaining = Math.max(0, endTime - now);
            
            const minutes = Math.floor(remaining / 60);
            const seconds = Math.floor(remaining % 60);
            
            const timerEl = document.getElementById('timer');
            timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            if (remaining < 30) {
                timerEl.classList.add('warning');
            }
            
            if (remaining <= 0) {
                clearInterval(timerInterval);
                if (currentState === 'answering' && !document.getElementById('submit-answer-btn').disabled) {
                    document.getElementById('submit-answer-btn').click();
                }
            }
        }, 1000);
    }
    
    function showVotingArea(answers) {
        if (timerInterval) clearInterval(timerInterval);
        
        document.getElementById('waiting-area').style.display = 'none';
        document.getElementById('answering-area').style.display = 'none';
        document.getElementById('voting-area').style.display = 'block';
        document.getElementById('results-area').style.display = 'none';
        
        allAnswers = answers;
        const list = document.getElementById('answers-list');
        list.innerHTML = '';
        
        answers.forEach((answer, idx) => {
            const box = document.createElement('div');
            box.className = 'answer-box';
            box.innerHTML = `
                <strong>å›ç­” ${idx + 1}</strong>
                <p style="margin-top: 10px; font-size: 1.1em;">${answer}</p>
            `;
            
            // è‡ªåˆ†ã®å›ç­”ã‚’ãƒã‚§ãƒƒã‚¯
            if (answer === myAnswer) {
                box.style.opacity = '0.5';
                box.style.cursor = 'not-allowed';
                box.innerHTML += '<p style="margin-top: 10px; color: #dc3545;"><strong>ã‚ãªãŸã®å›ç­”</strong></p>';
            } else {
                box.addEventListener('click', () => selectAnswer(idx, box));
            }
            
            list.appendChild(box);
        });
    }
    
    function selectAnswer(idx, element) {
        if (allAnswers[idx] === myAnswer) return;
        
        if (selectedFirst === null) {
            selectedFirst = idx;
            element.classList.add('selected');
            element.innerHTML += '<p style="margin-top: 10px;"><strong>1ä½ã«é¸æŠ</strong></p>';
            document.getElementById('first-place-display').textContent = `å›ç­” ${idx + 1}`;
        } else if (selectedSecond === null && idx !== selectedFirst) {
            selectedSecond = idx;
            element.classList.add('selected');
            element.innerHTML += '<p style="margin-top: 10px;"><strong>2ä½ã«é¸æŠ</strong></p>';
            document.getElementById('second-place-display').textContent = `å›ç­” ${idx + 1}`;
            document.getElementById('submit-vote-btn').disabled = false;
        } else {
            // ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('.answer-box').forEach(box => {
                box.classList.remove('selected');
            });
            selectedFirst = null;
            selectedSecond = null;
            document.getElementById('first-place-display').textContent = 'æœªé¸æŠ';
            document.getElementById('second-place-display').textContent = 'æœªé¸æŠ';
            document.getElementById('submit-vote-btn').disabled = true;
            
            // å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            showVotingArea(allAnswers);
        }
    }
    
    function showResults(data) {
        document.getElementById('waiting-area').style.display = 'none';
        document.getElementById('answering-area').style.display = 'none';
        document.getElementById('voting-area').style.display = 'none';
        document.getElementById('results-area').style.display = 'block';
        
        const list = document.getElementById('results-list');
        list.innerHTML = '';
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ç´¯è¨ˆãƒã‚¤ãƒ³ãƒˆé †ã«ã‚½ãƒ¼ãƒˆ
        const sortedPlayers = [...data.players].sort((a, b) => 
            data.cumulative_points[b.user_id] - data.cumulative_points[a.user_id]
        );
        
        sortedPlayers.forEach((player, rank) => {
            const card = document.createElement('div');
            card.className = 'card';
            
            let rankEmoji = '';
            if (rank === 0) rankEmoji = 'ğŸ¥‡';
            else if (rank === 1) rankEmoji = 'ğŸ¥ˆ';
            else if (rank === 2) rankEmoji = 'ğŸ¥‰';
            else rankEmoji = `${rank + 1}ä½`;
            
            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: #667eea;">${rankEmoji} ${player.username}</h3>
                    <div style="font-size: 1.5em; font-weight: bold; color: #ffc107;">
                        ${data.cumulative_points[player.user_id]}pt
                    </div>
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                    <p style="font-size: 1.1em;">${player.answer || 'å›ç­”ãªã—'}</p>
                </div>
            `;
            
            list.appendChild(card);
        });
        
        // å‹è€…ã‚’å¼·èª¿
        if (data.winner) {
            list.insertAdjacentHTML('afterbegin', `
                <div style="background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color: #333; padding: 30px; border-radius: 15px; text-align: center; margin-bottom: 30px;">
                    <h2 style="font-size: 2.5em; margin-bottom: 10px;">ğŸ‰ ${data.winner.username} ã®å‹åˆ©ï¼ ğŸ‰</h2>
                    <p style="font-size: 1.3em;">${data.cumulative_points[data.winner.user_id]} ãƒã‚¤ãƒ³ãƒˆç²å¾—</p>
                </div>
            `);
        }
    }
    
    // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã«ãƒ«ãƒ¼ãƒ ã‹ã‚‰é€€å‡º
    window.addEventListener('beforeunload', () => {
        socket.emit('leave_room', {room_id: roomId});
    });
</script>
{% endblock %}